---
title: '校验 MySQL 连接有效性'
layout: post
subtitle: "MySQL"
tags:
  - mysql
---

项目中一直有一个顽疾，就是数据库连接池这块。现在用的连接池是之前团队自己写的，然后和项目耦合的很紧，没办法直接替换掉，所以一直没动过。


### 流量暴增带来的问题
运营每天早上会向所有用户发送推送，emmmm，标题党那种，一看标题就让人很想点开的那种，所以每天那个时间点的 QPS 会突增，平时大概 200-300 左右，但是那个时间点的峰值 1500-5000 左右。几秒之内突然暴涨 10 倍。每到那个时间点超时就很严重，后台日志很多 db connection pool is full。是的，数据库连接池被直接打满了，那个时候所有服务加一块配了大概 3k 多的连接数，但是实际上其他项目组日活比我们大很多，他们占用连接数才 1k 不到。他们是 PHP 服务，抛开技术上的差异，按道理也不应该差这么多的。后来排查发现最小连接数配的很小，只有 20。那就意味着高峰期流量突增的时候，要一个一个的创建连接，直到最大值 1000。创建连接的过程相对来说算是比较耗时的过程了，在急需使用的时候还要一个一个去创建，这里明显可以优化下，后来直接把最小连接数配置成和最大值一致。在业务上也想办法优化了下，将早上的推送分批进行，现在采用的方案就是将 Android 和 IOS 设备的推送分开并间隔五分钟。后来超时问题基本解决了。

对于大型互联网公司来说这种情况可能会比较常见，他们也有成熟的应对方案，总结概括起来无非就是削峰、限流、扩容。  
削峰就是想办法将峰值摊平，比如我们采用分开推送的方案就是，之前我们查看流量图的时候只有一个很高的峰，但是现在就变成两个峰了。
![](/media/images/20180305182931.jpg)


###
